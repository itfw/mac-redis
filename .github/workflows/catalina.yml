name: Build Redis for macOS 

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g. v7.2.0)'
        required: true
        type: string

jobs:
  build:
    # ä½¿ç”¨ macos-13 (Ventura)ï¼šä»åŒ…å« Intel æœºå™¨ï¼Œä¸”èƒ½è®¾ç½®ä½éƒ¨ç½²ç›®æ ‡
    # é¿å… macos-14ï¼ˆSonomaï¼‰ï¼šé»˜è®¤ Apple Silicon + é«˜ SDKï¼Œå…¼å®¹æ€§é£é™©æ›´é«˜
    runs-on: macos-13

    steps:
      - name: Checkout Redis source
        uses: actions/checkout@v4
        with:
          repository: redis/redis
          # å¦‚éœ€ç‰¹å®šç‰ˆæœ¬ï¼Œå¯åŠ  ref: 7.2.0 ç­‰

      - name: Set environment for maximum Catalina compatibility
        run: |
          echo "Setting deployment target to 10.15 (Catalina)"
          echo "MACOSX_DEPLOYMENT_TARGET=10.15" >> $GITHUB_ENV
          # å¼ºåˆ¶ä½¿ç”¨ Intel æ¶æ„ï¼ˆCatalina ä¸»è¦åœ¨ Intel Mac ä¸Šè¿è¡Œï¼‰
          echo "ARCHS=x86_64" >> $GITHUB_ENV
          echo "CFLAGS=-arch x86_64" >> $GITHUB_ENV
          echo "LDFLAGS=-arch x86_64" >> $GITHUB_ENV

      - name: Compile Redis (Catalina-safe)
        env:
          MACOSX_DEPLOYMENT_TARGET: 10.15
          ARCHS: x86_64
        run: |
          # ç¦ç”¨ jemallocï¼šCatalina ä¸Š libc malloc æ›´ç¨³å®š
          # æ˜¾å¼æŒ‡å®šæ¶æ„ä¸º x86_64ï¼ˆé¿å…ç”Ÿæˆ ARM64ï¼‰
          make -j$(sysctl -n hw.ncpu) \
            USE_JEMALLOC=no \
            CFLAGS="-arch x86_64 -mmacosx-version-min=10.15" \
            LDFLAGS="-arch x86_64"

      - name: Verify binaries are x86_64 and compatible with 10.15
        run: |
          echo "=== Redis Version ==="
          ./src/redis-server --version

          echo "=== Binary Architecture ==="
          file ./src/redis-server

          echo "=== Load Commands (Deployment Target) ==="
          otool -l ./src/redis-server | grep -A3 -E "LC_VERSION_MIN_MACOSX|LC_BUILD_VERSION" || echo "No version command found"

          echo "=== Check for any ARM64 or multi-arch ==="
          lipo -info ./src/redis-server || true

      - name: Test basic functionality (optional but recommended)
        run: |
          timeout 5s ./src/redis-server --daemonize yes --port 6380 || true
          sleep 1
          ./src/redis-cli -p 6380 ping || echo "Redis test failed (may be okay in CI)"
          ./src/redis-cli -p 6380 shutdown || true

      - name: Package and upload artifact
        run: |
          mkdir -p redis-catalina
          cp src/redis-server src/redis-cli src/redis-benchmark src/redis-check-rdb src/redis-check-aof redis-catalina/
          tar -czvf redis-macos-catalina-x86_64.tar.gz -C redis-catalina .

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: redis-macos-catalina-x86_64
          path: redis-macos-catalina-x86_64.tar.gz
      
      - name: Release to GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Redis ${{ github.event.inputs.release_tag }} for macOS Catalina
          draft: false
          prerelease: false
          files: redis-macos-catalina-x86_64.tar.gz
          body: |
            ğŸ macOS Catalina (10.15+) compatible Redis binaries (Intel x86_64 only)

            Includes:
            - redis-server
            - redis-cli
            - redis-benchmark
            - redis-check-rdb
            - redis-check-aof

            Built from official Redis source.
            Deployment target: macOS 10.15
            Architecture: x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
